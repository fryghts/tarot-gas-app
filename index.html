<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Цифровой Оракул: IT-Таро</title>
    <style>
        /* --- ОБЩИЕ СТИЛИ --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Orbitron:wght@400;700&display=swap');

        :root {
            --font-main: 'Inter', sans-serif;
            --font-title: 'Orbitron', sans-serif;
            --card-width: 80px;
            --card-height: 128px;
            --card-spacing: 20px;
            --animation-duration: 0.7s;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: var(--font-main);
            overflow: hidden;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.5s;
            -webkit-user-select: none; -ms-user-select: none; user-select: none;
            touch-action: none;
        }

        .app-container {
            width: 100vw; height: 100vh; display: flex;
            justify-content: center; align-items: center;
            perspective: 2000px; position: relative; z-index: 1;
        }
        
        .app-container::before {
            content: '';
            position: absolute;
            inset: 0;
            background-color: #000;
            opacity: 0;
            z-index: 1;
            pointer-events: none;
            transition: opacity 2s ease-in-out;
        }
        .app-container.focus-active::before {
            opacity: 0.6;
        }

        #particles-js { position: fixed; width: 100%; height: 100%; top: 0; left: 0; z-index: 0; }
        
        #confetti-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10000;
        }

        .screen {
            position: absolute; width: 100%; height: 100%; display: flex;
            flex-direction: column; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.8s;
            padding: 1rem; text-align: center;
            z-index: 2;
        }
        .screen.active { opacity: 1; pointer-events: auto; }
        .title { font-family: var(--font-title); font-size: clamp(2rem, 6vw, 4rem); font-weight: 700; margin-bottom: 1rem; }
        .subtitle { font-size: clamp(0.9rem, 2.5vw, 1.2rem); max-width: 600px; margin-bottom: 2rem; line-height: 1.6; }
        
        .shining-text {
            color: var(--secondary-color);
            text-shadow: 0 0 7px var(--highlight-color), 0 0 12px var(--highlight-color);
            animation: text-glow 3s ease-in-out infinite alternate;
        }
        @keyframes text-glow {
            from { text-shadow: 0 0 7px var(--highlight-color), 0 0 12px var(--highlight-color); }
            to { text-shadow: 0 0 12px var(--highlight-color), 0 0 24px var(--highlight-color), 0 0 4px #fff; }
        }

        .action-button {
            font-family: var(--font-title); padding: 1rem 2.5rem; border-radius: 50px; border: none;
            font-size: 1.1rem; cursor: pointer; transition: all 0.3s;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3); touch-action: manipulation;
        }
        .action-button:hover { transform: translateY(-3px); box-shadow: 0 6px 25px rgba(0,0,0,0.4); }
        #logo-container { position: absolute; top: 1rem; left: 50%; transform: translateX(-50%); width: clamp(100px, 15vw, 150px); }
        #logo-container img { max-width: 100%; height: auto; filter: brightness(0) saturate(100%) invert(39%) sepia(82%) saturate(1347%) hue-rotate(191deg) brightness(96%) contrast(101%); }

        /* --- ТЕМЫ --- */
        .theme-gazprom-classic {
            --bg-color: #011d3a; --primary-color: #0078d7; --secondary-color: #ffffff;
            --text-color: #e0f7ff; --highlight-color: #00aaff; --card-back-bg: linear-gradient(145deg, #002f5c, #004b8f);
            --card-border: #00aaff;
        }
        .theme-gazprom-dark {
            --bg-color: #000814; --primary-color: #005f9e; --secondary-color: #ccdeeb;
            --text-color: #a9c7e0; --highlight-color: #3399ff; --card-back-bg: linear-gradient(145deg, #001a33, #002b52);
            --card-border: #0078d7;
        }
        .theme-gazprom-light {
            --bg-color: #e6f2ff; --primary-color: #005a9e; --secondary-color: #002d4f;
            --text-color: #004375; --highlight-color: #0078d7; --card-back-bg: linear-gradient(145deg, #cce5ff, #a3d1ff);
            --card-border: #005a9e;
        }
        
        .title { color: var(--secondary-color); text-shadow: 0 0 15px var(--primary-color); }
        .action-button { background-color: var(--primary-color); color: var(--bg-color) !important; }
        .action-button:hover { background-color: var(--highlight-color); }

        /* --- ЭКРАН ВЫБОРА (DRAG & DROP) --- */
        #choice-screen, #card-selection-area { position: absolute; inset: 0; overflow: hidden;}
        #initial-deck {
            position: absolute; top: 60%; left: 50%; width: 100px; height: 160px;
            transform: translate(-50%, -50%); cursor: pointer; transform-style: preserve-3d;
            transition: transform 0.3s, opacity 0.5s;
        }
        #initial-deck:hover { transform: translate(-50%, -50%) scale(1.05); }
        #initial-deck .shuffle-card {
            position: absolute; width: 100%; height: 100%; border-radius: 8px;
            background: var(--card-back-bg); border: 2px solid var(--card-border);
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }
        #spread-slots-sidebar {
            position: fixed; z-index: 20; background: rgba(0,0,0,0.3);
            border-radius: 10px; backdrop-filter: blur(10px); display: flex; gap: 10px;
        }
        .card-slot {
            width: var(--card-width); height: var(--card-height); border: 2px dashed var(--primary-color);
            border-radius: 8px; display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: var(--primary-color); transition: all 0.3s; font-size: 0.8rem;
        }
        .card-slot.drag-over { border-style: solid; transform: scale(1.05); }
        .card-slot .slot-label { font-family: var(--font-title); text-align: center; }

        .tarot-card {
            width: var(--card-width); height: var(--card-height); position: absolute; cursor: grab;
            transform-style: preserve-3d; border-radius: 6px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.4); touch-action: none;
            transform: translateZ(0);
            will-change: transform;
        }
        .tarot-card:active { cursor: grabbing; }
        .tarot-card.is-dragging { z-index: 1000; box-shadow: 0 8px 25px rgba(0,0,0,0.6); }
        
        .card-slot .tarot-card {
            width: 100%; height: 100%; cursor: default;
            position: relative; box-shadow: none;
            display: block; left: auto; top: auto;
            transform-style: preserve-3d;
        }

        .card-face {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; border-radius: inherit;
            background-size: cover; background-position: center; border: 1px solid var(--card-border);
        }
        .card-back { background: var(--card-back-bg); }
        .card-front { transform: rotateY(180deg); }

        /* --- АДАПТИВНОСТЬ --- */
        @media (max-width: 768px) and (orientation: portrait) { #spread-slots-sidebar { bottom: 20px; left: 50%; transform: translateX(-50%); flex-direction: row; padding: 15px; } }
        @media (max-width: 768px) and (orientation: landscape) { #spread-slots-sidebar { right: 20px; top: 50%; transform: translateY(-50%); flex-direction: column; padding: 15px; } .card-slot { width: 60px; height: 96px; font-size: 0.7rem; } :root { --card-width: 60px; --card-height: 96px; } }
        @media (min-width: 769px) { #spread-slots-sidebar { right: 30px; top: 50%; transform: translateY(-50%); flex-direction: column; padding: 20px; } }
        @media (min-width: 1025px) { .card-slot { width: 100px; height: 160px; } #spread-slots-sidebar { right: 40px; } :root { --card-width: 100px; --card-height: 160px; } }
        
        #slot-explanation { position: absolute; top: 5%; left: 50%; transform: translateX(-50%); width: 90%; max-width: 500px; line-height: 1.8; transition: opacity 0.5s; }
        #slot-explanation strong { color: var(--highlight-color); font-weight: normal;}
        
        .placement-toast {
            position: fixed; bottom: 20%; left: 50%; background: rgba(10, 20, 40, 0.9);
            color: var(--text-color); padding: 1rem 2rem; border-radius: 8px;
            border-top: 3px solid var(--highlight-color); box-shadow: 0 5px 25px rgba(0,0,0,0.5);
            text-align: center; z-index: 9999; pointer-events: none;
            animation: toast-fade 2.5s ease-out forwards;
        }
        .placement-toast h4 { font-family: var(--font-title); color: var(--highlight-color); margin-bottom: 0.25rem; }
        @keyframes toast-fade { 0% { opacity: 0; transform: translate(-50%, 20px); } 15%, 85% { opacity: 1; transform: translate(-50%, 0); } 100% { opacity: 0; transform: translate(-50%, -20px); } }

        /* DEV PANEL */
        #dev-panel { position: fixed; bottom: 20px; left: 20px; z-index: 200; }
        #dev-panel-toggle { width: 50px; height: 50px; background: rgba(0,0,0,0.5); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; border: 1px solid white; }
        #dev-panel-content { position: absolute; bottom: 60px; left: 0; background: rgba(0,0,0,0.8); border: 1px solid white; border-radius: 8px; padding: 1rem; width: 300px; display: none; grid-template-columns: 1fr; gap: 0.8rem; }
        #dev-panel-content.active { display: grid; }
        #dev-panel-content h4 { text-align: center; }
        .dev-group label { font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; }
        #dev-panel select, #dev-panel input, #dev-panel button { width: 100%; padding: 0.4rem; background: #333; color: white; border: 1px solid #555; border-radius: 4px; }
        #dev-panel button { cursor: pointer; background: var(--primary-color); margin-top: 0.5rem; }

        /* ЭФФЕКТЫ */
        .tarot-card.breathing-glow { animation: cardGlow 3.5s ease-in-out infinite; }
        @keyframes cardGlow { 0%, 100% { box-shadow: 0 0 10px rgba(0, 170, 255, 0.4); } 50% { box-shadow: 0 0 25px rgba(0, 170, 255, 0.9); } }
        .ripple-v1 { position: absolute; pointer-events: none; border-radius: 50%; background: radial-gradient(circle, rgba(0, 170, 255, 0.4) 0%, transparent 70%); transform: scale(0); animation: rippleEffect 0.6s ease-out; }
        @keyframes rippleEffect { to { transform: scale(4); opacity: 0; } }
        .card-slot.magnetic-pulse.attracting { transform: scale(1.08); border-style: solid; animation: magneticPulse 0.5s ease-in-out infinite alternate; }
        @keyframes magneticPulse { from { box-shadow: 0 0 15px var(--highlight-color); } to { box-shadow: 0 0 25px var(--highlight-color), 0 0 35px rgba(0, 170, 255, 0.5); } }
        #initial-deck.deck-breathing-mystic { animation: deckMystic 2.5s ease-in-out infinite; }
        @keyframes deckMystic { 0%, 100% { transform: translate(-50%, -50%) scale(1); filter: brightness(1) drop-shadow(0 0 10px rgba(0, 170, 255, 0.3)); } 50% { transform: translate(-50%, -50%) scale(1.08); filter: brightness(1.1) drop-shadow(0 0 20px rgba(0, 170, 255, 0.8)); } }
        
        /*
        ==============================================
        === СТИЛИ ДЛЯ ОКНА РЕЗУЛЬТАТОВ (ИНТЕГРАЦИЯ) ===
        ==============================================
        */
        :root {
            --challenge-primary: #ff6b35; --challenge-secondary: #ff8c42; --challenge-light: #ffb3a0; --challenge-bg: rgba(255, 107, 53, 0.15); --challenge-border: #ff6b35; --challenge-gradient: linear-gradient(135deg, #ff6b35, #ff8c42);
            --path-primary: #0078d7; --path-secondary: #00aaff; --path-light: #66ccff; --path-bg: rgba(0, 120, 215, 0.15); --path-border: #0078d7; --path-gradient: linear-gradient(135deg, #0078d7, #00aaff);
            --outcome-primary: #00d084; --outcome-secondary: #00e676; --outcome-light: #66ffb3; --outcome-bg: rgba(0, 208, 132, 0.15); --outcome-border: #00d084; --outcome-gradient: linear-gradient(135deg, #00d084, #00e676);
            --ai-primary: #7c3aed; --ai-secondary: #a855f7; --ai-light: #c084fc; --ai-bg: rgba(124, 58, 237, 0.15); --ai-border: #7c3aed; --ai-gradient: linear-gradient(135deg, #7c3aed, #a855f7);
        }

        .modal-overlay { display: none; /* Скрыто по умолчанию */ position: fixed; inset: 0; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(10px); justify-content: center; align-items: center; z-index: 100; padding: 15px; }
        .modal-overlay.active { display: flex; }
        
        .modal-content { background: #0a1428; border: 2px solid var(--primary-color); border-radius: 16px; width: 100%; height: 100%; max-width: 1200px; max-height: 95vh; position: relative; box-shadow: 0 0 40px var(--primary-color); overflow: hidden; transition: border-color 0.4s ease, box-shadow 0.4s ease; }
        .modal-close-button { position: absolute; top: 1rem; right: 1rem; background: rgba(0,0,0,0.5); border: 2px solid var(--primary-color); border-radius: 50%; color: #fff; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; cursor: pointer; transition: all 0.3s ease; z-index: 10; }
        .modal-close-button:hover { transform: rotate(90deg) scale(1.1); background: rgba(255,0,0,0.3); border-color: #ff4444; }

        .side-nav { position: absolute; top: 50%; transform: translateY(-50%); width: 50px; height: 80px; background: rgba(0,0,0,0.6); border: 2px solid var(--primary-color); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; z-index: 10; }
        .side-nav.left { left: -2px; border-radius: 0 25px 25px 0; border-left: none; }
        .side-nav.right { right: -2px; border-radius: 25px 0 0 25px; border-right: none; }
        .side-nav svg { width: 24px; height: 24px; fill: var(--highlight-color); transition: fill 0.3s ease; }
        .side-nav:disabled { opacity: 0.3; cursor: not-allowed; }
        
        .modal-content.challenge-theme { border-color: var(--challenge-primary); }
        .challenge-theme .side-nav { border-color: var(--challenge-primary); } .challenge-theme .side-nav svg { fill: var(--challenge-secondary); }
        .modal-content.path-theme { border-color: var(--path-primary); }
        .path-theme .side-nav { border-color: var(--path-primary); } .path-theme .side-nav svg { fill: var(--path-secondary); }
        .modal-content.outcome-theme { border-color: var(--outcome-primary); }
        .outcome-theme .side-nav { border-color: var(--outcome-primary); } .outcome-theme .side-nav svg { fill: var(--outcome-secondary); }
        .modal-content.ai-theme { border-color: var(--ai-primary); }
        .ai-theme .side-nav { border-color: var(--ai-primary); } .ai-theme .side-nav svg { fill: var(--ai-secondary); }

        .screens-container { width: 100%; height: 100%; position: relative; overflow: hidden; z-index: 2; }
        .result-screen { position: absolute; width: 100%; height: 100%; padding: 1.5rem; display: flex; opacity: 0; transform: translateX(100%); transition: all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .result-screen.active { opacity: 1; transform: translateX(0); }
        .result-screen.prev { transform: translateX(-100%); }

        .result-image-section { flex: 1.2; display: flex; align-items: center; justify-content: center; padding-right: 1.5rem; }
        .result-image-wrapper { width: 100%; max-width: 380px; aspect-ratio: 5/8; border-radius: 15px; border: 3px solid; position: relative; cursor: zoom-in; box-shadow: 0 10px 30px rgba(0,0,0,0.3); overflow: hidden; }
        .result-image { width: 100%; height: 100%; object-fit: cover; }
        .result-image-wrapper:hover .result-image { transform: scale(1.05); }

        .result-image-wrapper::after { content: ''; position: absolute; inset: -5px; border-radius: 20px; opacity: 0.6; z-index: -1; animation: glow-pulse 4s ease-in-out infinite; }
        .challenge-theme .result-image-wrapper { border-color: var(--challenge-border); }
        .challenge-theme .result-image-wrapper::after { box-shadow: 0 0 60px 10px var(--challenge-primary); }
        .path-theme .result-image-wrapper { border-color: var(--path-border); }
        .path-theme .result-image-wrapper::after { box-shadow: 0 0 60px 10px var(--path-primary); }
        .outcome-theme .result-image-wrapper { border-color: var(--outcome-border); }
        .outcome-theme .result-image-wrapper::after { box-shadow: 0 0 60px 10px var(--outcome-primary); }
        .ai-theme .result-image-wrapper { border-color: var(--ai-border); }
        .ai-theme .result-image-wrapper::after { box-shadow: 0 0 60px 10px var(--ai-primary); }
        @keyframes glow-pulse { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }

        .result-content-section { flex: 1; display: flex; flex-direction: column; gap: 1rem; overflow-y: auto; padding: 0.5rem; }
        .result-title-section { text-align: center; margin-bottom: 1rem; }
        .result-aspect-label { font-family: var(--font-title); font-size: 1rem; text-transform: uppercase; letter-spacing: 2px; font-weight: 600; }
        .result-card-name { font-family: var(--font-title); font-size: 1.8rem; color: var(--secondary-color); margin-top: 0.5rem; }
        .challenge-theme .result-aspect-label { background: var(--challenge-gradient); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
        .path-theme .result-aspect-label { background: var(--path-gradient); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
        .outcome-theme .result-aspect-label { background: var(--outcome-gradient); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
        .ai-theme .result-aspect-label { background: var(--ai-gradient); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }

        .guidance-text { font-style: italic; line-height: 1.6; color: var(--text-color); font-size: 0.85rem; opacity: 0.8; margin-bottom: 1rem; border-left: 3px solid; padding-left: 1rem; }
        .challenge-theme .guidance-text { border-color: var(--challenge-primary); }
        .path-theme .guidance-text { border-color: var(--path-primary); }
        .outcome-theme .guidance-text { border-color: var(--outcome-primary); }

        .content-block { border-radius: 12px; padding: 1.2rem; backdrop-filter: blur(5px); }
        .challenge-theme .content-block { background: rgba(255,107,53,0.1); border: 1px solid rgba(255,107,53,0.2); }
        .path-theme .content-block { background: rgba(0,120,215,0.1); border: 1px solid rgba(0,120,215,0.2); }
        .outcome-theme .content-block { background: rgba(0,208,132,0.1); border: 1px solid rgba(0,208,132,0.2); }
        .content-block-header { display: flex; align-items: center; gap: 0.8rem; font-family: var(--font-title); font-size: 1.1rem; color: var(--secondary-color); cursor: pointer; }
        .content-block-details { max-height: 0; overflow: hidden; transition: max-height 0.6s ease-in-out; }
        .content-block.open .content-block-details { max-height: 500px; padding-top: 1rem; }
        .content-text { color: var(--text-color); line-height: 1.6; font-size: 0.95rem; }

        .keywords { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 1rem; }
        .keyword { padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.75rem; font-weight: 500; }
        .challenge-theme .keyword { background: var(--challenge-bg); border: 1px solid var(--challenge-primary); color: var(--challenge-light); }
        .path-theme .keyword { background: var(--path-bg); border: 1px solid var(--path-primary); color: var(--path-light); }
        .outcome-theme .keyword { background: var(--outcome-bg); border: 1px solid var(--outcome-primary); color: var(--outcome-light); }
        
        #ai-screen-content { text-align: center; max-width: 500px; margin: 0 auto; }
        #ai-screen-content .ai-title { font-size: 2.5rem; background: var(--ai-gradient); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
        #ai-screen-content .ai-subtitle { font-size: 1.1rem; margin: 1rem 0 2rem; }
        .ai-action-btn { padding: 1.2rem 3rem; border-radius: 50px; font-family: var(--font-title); font-size: 1.2rem; cursor: pointer; transition: all 0.4s ease; border: none; background: var(--ai-gradient); color: white; box-shadow: 0 8px 30px rgba(124, 58, 237, 0.4); }
        .ai-action-btn:hover { transform: translateY(-4px) scale(1.05); }

        .fullscreen-overlay, .ai-overlay { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 10000; opacity: 0; transition: opacity 0.4s ease; backdrop-filter: blur(20px); }
        .fullscreen-overlay.active, .ai-overlay.active { display: flex; opacity: 1; }
        .fullscreen-image { max-width: 90vw; max-height: 90vh; border-radius: 20px; box-shadow: 0 0 100px rgba(0,170,255,0.5); }
        .ai-panel { background: linear-gradient(135deg, rgba(10,20,40,0.95), rgba(30,50,80,0.95)); border: 2px solid var(--ai-primary); border-radius: 20px; padding: 2.5rem; max-width: 700px; width: 90%; animation: aiPanelAppear 0.6s ease; }
        @keyframes aiPanelAppear { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
        .ai-panel .ai-title { font-family: var(--font-title); font-size: 1.5rem; background: var(--ai-gradient); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 1rem; }
        .ai-input-group { display: flex; gap: 1rem; margin-bottom: 1.5rem; }
        .ai-input { flex: 1; padding: 1.2rem; background: rgba(0,0,0,0.4); border: 2px solid var(--ai-primary); border-radius: 25px; color: #fff; font-size: 1rem; }
        .ai-btn { padding: 1rem; border: none; border-radius: 25px; background: var(--ai-gradient); color: white; cursor: pointer; }
        .ai-response { background: rgba(0,0,0,0.4); border: 1px solid var(--ai-secondary); border-radius: 15px; padding: 1.5rem; margin-top: 1rem; min-height: 120px; display: none; }
        .ai-response.visible { display: block; }

        @media (max-width: 768px) {
            .result-screen { flex-direction: column; padding: 1rem; }
            .result-image-section { flex: 0; padding-right: 0; padding-bottom: 1rem; align-self: center; }
            .result-image-wrapper { max-width: 250px; }
            .result-content-section { flex: 1; max-height: 50vh; }
        }
        
        .result-content-section::-webkit-scrollbar { width: 6px; }
        .result-content-section::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        .result-content-section::-webkit-scrollbar-thumb { background: var(--primary-color); border-radius: 3px; }
        .challenge-theme .result-content-section::-webkit-scrollbar-thumb { background: var(--challenge-primary); }
        .path-theme .result-content-section::-webkit-scrollbar-thumb { background: var(--path-primary); }
        .outcome-theme .result-content-section::-webkit-scrollbar-thumb { background: var(--outcome-primary); }
    </style>
</head>
<body class="theme-gazprom-classic">

    <div id="particles-js"></div>
    <canvas id="confetti-canvas"></canvas>

    <div class="app-container">
        <div id="start-screen" class="screen active">
            <div id="logo-container"><img src="logo.svg" alt="Логотип" /></div>
            <h1 class="title">Цифровой Оракул</h1>
            <p class="subtitle">Какой баг ждет тебя в следующем спринте? Узнай свою IT-судьбу.</p>
            <button id="start-btn" class="action-button">Начать сеанс</button>
        </div>

        <div id="focus-screen" class="screen">
            <h1 class="title shining-text">Концентрация</h1>
            <p class="subtitle shining-text">Подумайте о проекте, карьерном пути или технологическом вызове, который вас волнует. Сконцентрируйтесь на нём.</p>
        </div>

        <div id="choice-screen" class="screen">
            <div id="card-selection-area"></div>
            <div id="spread-slots-sidebar">
                <div class="card-slot" data-slot-id="0"><span class="slot-label">Вызов</span></div>
                <div class="card-slot" data-slot-id="1"><span class="slot-label">Путь</span></div>
                <div class="card-slot" data-slot-id="2"><span class="slot-label">Исход</span></div>
            </div>
            <div id="slot-explanation" class="subtitle shining-text">
                Три карты определят твой путь.<br>
                Первая укажет на <strong>Вызов</strong>. Вторая откроет <strong>Путь</strong>.<br>
                Третья предскажет <strong>Исход</strong>.
            </div>
        </div>
    </div>

    <div id="result-modal" class="modal-overlay">
        <div class="modal-content" id="modal-content">
            <button id="close-modal-btn" class="modal-close-button">&times;</button>
            <button class="side-nav left" id="prev-btn">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            </button>
            <button class="side-nav right" id="next-btn">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
            </button>
            <div class="screens-container" id="screens-container">
                </div>
        </div>
    </div>

    <div class="fullscreen-overlay" id="fullscreen-overlay">
        <img id="fullscreen-image" class="fullscreen-image" src="" alt="">
    </div>

    <div class="ai-overlay" id="ai-overlay">
        <div class="ai-panel">
            <div class="ai-title">🤖 Персональный анализ</div>
            <p>Задайте уточняющий вопрос по вашему раскладу, чтобы получить глубокую интерпретацию.</p>
            <div class="ai-input-group">
                <input type="text" class="ai-input" id="ai-question" placeholder="Например: какие риски в проекте?">
                <button class="ai-btn" onclick="ResultScreen.requestAI()"><span id="ai-btn-text">Спросить</span></button>
            </div>
            <div class="ai-response" id="ai-response"></div>
            <div style="text-align: center; margin-top: 1.5rem;">
                <button class="ai-btn" onclick="ResultScreen.hideAI()" style="padding: 0.8rem 2rem;">Закрыть</button>
            </div>
        </div>
    </div>

    <div id="dev-panel">
        <div id="dev-panel-toggle">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19.8293 10.1707C19.9392 10.7839 20 11.3895 20 12C20 12.6105 19.9392 13.2161 19.8293 13.8293L21.8293 15.3293C22.0678 15.513 22.1465 15.8329 22.0415 16.1159L20.0415 19.5819C19.9365 19.8649 19.6429 20.0351 19.3453 19.9707L16.9453 19.0707C16.3216 19.5393 15.6347 19.9234 14.8962 20.2101L14.5 22.7C14.4444 23.0041 14.1843 23.2204 13.8703 23.2204H10.1297C9.81568 23.2204 9.55558 23.0041 9.5 22.7L9.10383 20.2101C8.36531 19.9234 7.67842 19.5393 7.05471 19.0707L4.65471 19.9707C4.35714 20.0351 4.06346 19.8649 3.95848 19.5819L1.95848 16.1159C1.8535 15.8329 1.93221 15.513 2.17073 15.3293L4.17073 13.8293C4.06083 13.2161 4 12.6105 4 12C4 11.3895 4.06083 10.7839 4.17073 10.1707L2.17073 8.67073C1.93221 8.48705 1.8535 8.16712 1.95848 7.8841L3.95848 4.4181C4.06346 4.1351 4.35714 3.96486 4.65471 4.02928L7.05471 4.92928C7.67842 4.46071 8.36531 4.0766 9.10383 3.78988L9.5 1.3C9.55558 0.99593 9.81568 0.77965 10.1297 0.77965H13.8703C14.1843 0.77965 14.4444 0.99593 14.5 1.3L14.8962 3.78988C15.6347 4.0766 16.3216 4.46071 16.9453 4.92928L19.3453 4.02928C19.6429 3.96486 19.9365 4.1351 20.0415 4.4181L22.0415 7.8841C22.1465 8.16712 22.0678 8.48705 21.8293 8.67073L19.8293 10.1707ZM12 16C14.2091 16 16 14.2091 16 12C16 9.79086 14.2091 8 12 8C9.79086 8 8 9.79086 8 12C8 14.2091 9.79086 16 12 16Z"/></svg>
        </div>
        <div id="dev-panel-content">
            <h4>Dev Panel</h4>
            <div class="dev-group">
                <label for="theme-select">Тема:</label>
                <select id="theme-select">
                    <option value="theme-gazprom-classic">Классический синий</option>
                    <option value="theme-gazprom-dark">Глубокий космос</option>
                    <option value="theme-gazprom-light">Полярный день</option>
                </select>
            </div>
            <div class="dev-group"><label>Звуки<input type="checkbox" id="sound-effects-toggle"></label></div>
            <div class="dev-group"><label>Свечение карт<input type="checkbox" id="breathing-cards-toggle"></label></div>
            <div class="dev-group"><label>Ripple эффект<input type="checkbox" id="ripple-effects-toggle"></label></div>
            <div class="dev-group"><label>Магнитное притяжение<input type="checkbox" id="magnetic-snap-toggle"></label></div>
            <div class="dev-group"><label>Confetti<input type="checkbox" id="confetti-toggle"></label></div>
            <div class="dev-group"><label>Вибрация<input type="checkbox" id="vibration-toggle"></label></div>
            <div class="dev-group"><label>Дыхание колоды<input type="checkbox" id="deck-breathing-toggle"></label></div>
            <button id="restart-app-btn">Перезапустить</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script src="data.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const CONSTANTS = { CARD_SPACING: 20, ANIMATION_DURATION: 700, TOAST_DURATION: 2500, MIN_CARD_DISTANCE: 100, CONFETTI_COUNT: 50 };
            const UI = {
                screens: { start: document.getElementById('start-screen'), focus: document.getElementById('focus-screen'), choice: document.getElementById('choice-screen') },
                buttons: { start: document.getElementById('start-btn') },
                containers: { cardSlots: document.querySelectorAll('.card-slot'), cardArea: document.getElementById('card-selection-area'), app: document.querySelector('.app-container') },
                devPanel: {
                    toggle: document.getElementById('dev-panel-toggle'), content: document.getElementById('dev-panel-content'),
                    elements: { themeSelect: document.getElementById('theme-select'), soundToggle: document.getElementById('sound-effects-toggle'), breathingToggle: document.getElementById('breathing-cards-toggle'), rippleToggle: document.getElementById('ripple-effects-toggle'), magneticToggle: document.getElementById('magnetic-snap-toggle'), confettiToggle: document.getElementById('confetti-toggle'), vibrationToggle: document.getElementById('vibration-toggle'), deckBreathingToggle: document.getElementById('deck-breathing-toggle'), restartBtn: document.getElementById('restart-app-btn') }
                }
            };
            let appState = { chosenCards: new Array(3).fill(null), draggedCard: null, dragOffset: { x: 0, y: 0 }, audioContext: null, sounds: {}, confettiCanvas: null, confettiContext: null, confettiParticles: [] };
            let effects = { sounds: { enabled: true }, breathing: { enabled: true }, ripple: { enabled: true }, magnetic: { enabled: true }, confetti: { enabled: true }, vibration: { enabled: false }, deckBreathing: { enabled: false } };

            const Settings = {
                load() { const saved = localStorage.getItem('tarot-effects'); if (saved) { try { effects = { ...effects, ...JSON.parse(saved) }; } catch (e) { console.error('Ошибка загрузки настроек:', e); } } },
                save() { localStorage.setItem('tarot-effects', JSON.stringify(effects)); },
                applyToUI() { Object.entries(UI.devPanel.elements).forEach(([key, element]) => { if (element && element.type === 'checkbox') { const effectName = key.replace('Toggle', ''); if (effects[effectName]) { element.checked = effects[effectName].enabled; } } }); }
            };

            const Audio = {
                init() { if (!appState.audioContext && effects.sounds.enabled) { try { const AudioContext = window.AudioContext || window.webkitAudioContext; appState.audioContext = new AudioContext(); this.createSounds(); } catch (e) { console.warn('Audio not supported:', e); effects.sounds.enabled = false; } } },
                createSounds() { const createTone = (frequency, duration, volume, type = 'sine') => () => { if (!appState.audioContext || !effects.sounds.enabled) return; try { const oscillator = appState.audioContext.createOscillator(); const gainNode = appState.audioContext.createGain(); oscillator.connect(gainNode); gainNode.connect(appState.audioContext.destination); oscillator.type = type; oscillator.frequency.setValueAtTime(frequency, appState.audioContext.currentTime); gainNode.gain.setValueAtTime(0, appState.audioContext.currentTime); gainNode.gain.linearRampToValueAtTime(volume, appState.audioContext.currentTime + 0.01); gainNode.gain.exponentialRampToValueAtTime(0.001, appState.audioContext.currentTime + duration); oscillator.start(appState.audioContext.currentTime); oscillator.stop(appState.audioContext.currentTime + duration); } catch (e) { console.warn('Ошибка воспроизведения звука:', e); } }; appState.sounds = { cardClick: createTone(659, 0.5, 0.15), cardDrop: createTone(523, 0.8, 0.2), cardFlip: createTone(784, 0.6, 0.12), complete: () => { createTone(523, 0.5, 0.1)(); setTimeout(() => createTone(659, 0.5, 0.1)(), 100); setTimeout(() => createTone(784, 0.5, 0.1)(), 200); } }; },
                play(soundName) { if (appState.sounds[soundName]) { appState.sounds[soundName](); } }
            };

            const Vibration = { trigger(pattern) { if (effects.vibration.enabled && 'vibrate' in navigator) { try { navigator.vibrate(pattern); } catch (e) { console.warn('Vibration failed:', e); } } } };
            const Effects = {
                createRipple(x, y, element) { if (!effects.ripple.enabled) return; const ripple = document.createElement('div'); ripple.className = 'ripple-v1'; const size = 100; Object.assign(ripple.style, { width: `${size}px`, height: `${size}px`, left: `${x - size / 2}px`, top: `${y - size / 2}px` }); element.appendChild(ripple); setTimeout(() => ripple.remove(), 600); },
                updateBreathingCards() { document.querySelectorAll('.tarot-card:not(.is-dropped)').forEach(card => card.classList.toggle('breathing-glow', effects.breathing.enabled)); },
                updateMagneticSlots() { UI.containers.cardSlots.forEach(slot => slot.classList.toggle('magnetic-pulse', effects.magnetic.enabled)); },
                updateDeckBreathing() { const deck = document.getElementById('initial-deck'); if (deck) { deck.classList.toggle('deck-breathing-mystic', effects.deckBreathing.enabled); } }
            };

            const Navigation = { switchScreen(screenName) { Object.values(UI.screens).forEach(screen => screen.classList.remove('active')); if (UI.screens[screenName]) { UI.screens[screenName].classList.add('active'); } } };
            const Particles = { init() { if (!window.particlesJS) return; const theme = document.body.className || 'theme-gazprom-classic'; const colors = { 'theme-gazprom-classic': { p: "#00aaff", l: "#0078d7" }, 'theme-gazprom-dark': { p: "#3399ff", l: "#005f9e" }, 'theme-gazprom-light': { p: "#0078d7", l: "#005a9e" } }; const color = colors[theme] || colors['theme-gazprom-classic']; particlesJS('particles-js', { particles: { number: { value: 60 }, color: { value: color.p }, size: { value: 3, random: true }, move: { enable: true, speed: 2 }, line_linked: { color: color.l, distance: 150 } }, interactivity: { events: { onhover: { enable: true, mode: "repulse" } } } }); } };
            const Confetti = { init() { appState.confettiCanvas = document.getElementById('confetti-canvas'); appState.confettiContext = appState.confettiCanvas.getContext('2d'); const resize = () => { appState.confettiCanvas.width = window.innerWidth; appState.confettiCanvas.height = window.innerHeight; }; window.addEventListener('resize', resize); resize(); }, create() { if (!effects.confetti.enabled || !appState.confettiContext) return; const colors = ['#00aaff', '#0078d7', '#ffffff']; for (let i = 0; i < CONSTANTS.CONFETTI_COUNT; i++) { appState.confettiParticles.push({ x: Math.random() * appState.confettiCanvas.width, y: -20, vx: Math.random() * 10 - 5, vy: Math.random() * 5 + 5, color: colors[Math.floor(Math.random() * colors.length)], size: Math.random() * 8 + 4 }); } if (appState.confettiParticles.length > 0) { this.animate(); } }, animate() { if (!appState.confettiContext) return; appState.confettiContext.clearRect(0, 0, appState.confettiCanvas.width, appState.confettiCanvas.height); for (let i = appState.confettiParticles.length - 1; i >= 0; i--) { const particle = appState.confettiParticles[i]; particle.x += particle.vx; particle.y += particle.vy; particle.vy += 0.2; appState.confettiContext.fillStyle = particle.color; appState.confettiContext.fillRect(particle.x, particle.y, particle.size, particle.size); if (particle.y > appState.confettiCanvas.height + 20) { appState.confettiParticles.splice(i, 1); } } if (appState.confettiParticles.length > 0) { requestAnimationFrame(() => this.animate()); } } };
            
            const CardDealing = {
                calculateSafeArea() {
                    const areaRect = UI.containers.cardArea.getBoundingClientRect();
                    const slots = Array.from(UI.containers.cardSlots);
                    const slotBounds = slots.reduce((bounds, slot) => { const rect = slot.getBoundingClientRect(); return { minX: Math.min(bounds.minX, rect.left - areaRect.left), maxX: Math.max(bounds.maxX, rect.right - areaRect.left), minY: Math.min(bounds.minY, rect.top - areaRect.top), maxY: Math.max(bounds.maxY, rect.bottom - areaRect.top) }; }, { minX: Infinity, maxX: -Infinity, minY: Infinity, maxY: -Infinity });
                    const isPortrait = window.innerHeight > window.innerWidth;
                    const isMobile = window.innerWidth <= 768;
                    if (isMobile && !isPortrait) return { x: CONSTANTS.CARD_SPACING, y: CONSTANTS.CARD_SPACING, width: Math.max(200, slotBounds.minX - CONSTANTS.CARD_SPACING * 3), height: areaRect.height - CONSTANTS.CARD_SPACING * 2 };
                    if (isMobile && isPortrait) return { x: CONSTANTS.CARD_SPACING, y: CONSTANTS.CARD_SPACING, width: areaRect.width - CONSTANTS.CARD_SPACING * 2, height: Math.max(200, slotBounds.minY - CONSTANTS.CARD_SPACING * 3) };
                    return { x: CONSTANTS.CARD_SPACING, y: CONSTANTS.CARD_SPACING, width: Math.max(300, slotBounds.minX - CONSTANTS.CARD_SPACING * 3), height: areaRect.height - CONSTANTS.CARD_SPACING * 2 };
                },
                generateCardPositions(cardCount, cardWidth, cardHeight) {
                    const safeArea = this.calculateSafeArea();
                    const positions = [];
                    for (let i = 0; i < cardCount; i++) {
                        let position, attempts = 0;
                        do { position = { x: safeArea.x + Math.random() * (safeArea.width - cardWidth), y: safeArea.y + Math.random() * (safeArea.height - cardHeight), rotation: Math.random() * 40 - 20 }; attempts++; } while (this.checkCollision(position, positions) && attempts < 50);
                        positions.push(position);
                    }
                    return positions;
                },
                checkCollision(newPos, existingPositions) { return existingPositions.some(pos => Math.hypot(newPos.x - pos.x, newPos.y - pos.y) < CONSTANTS.MIN_CARD_DISTANCE); }
            };

            const GameLogic = {
                setupChoiceScreen() {
                    Navigation.switchScreen('choice');
                    const explanation = document.getElementById('slot-explanation');
                    if (explanation) explanation.style.opacity = '1';
                    appState.chosenCards.fill(null);
                    UI.containers.cardSlots.forEach((slot, index) => { slot.innerHTML = `<span class="slot-label">${["Вызов", "Путь", "Исход"][index]}</span>`; slot.classList.remove('filled'); });
                    UI.containers.cardArea.innerHTML = '';
                    const initialDeck = document.createElement('div');
                    initialDeck.id = 'initial-deck';
                    for (let i = 0; i < 5; i++) { const card = document.createElement('div'); card.className = 'shuffle-card'; card.style.transform = `translateZ(${i * -2}px)`; initialDeck.appendChild(card); }
                    UI.containers.cardArea.appendChild(initialDeck);
                    Effects.updateDeckBreathing();
                    initialDeck.addEventListener('click', this.dealCards.bind(this), { once: true });
                },
                dealCards() {
                    const deck = document.getElementById('initial-deck');
                    if (!deck) return;
                    gsap.to('#slot-explanation', { opacity: 0, duration: 0.3, pointerEvents: 'none' });
                    const shuffledCards = [...tarotCardsData].sort(() => 0.5 - Math.random());
                    const deckRect = deck.getBoundingClientRect();
                    const areaRect = UI.containers.cardArea.getBoundingClientRect();
                    const cardWidth = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--card-width'));
                    const cardHeight = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--card-height'));
                    const positions = CardDealing.generateCardPositions(shuffledCards.length, cardWidth, cardHeight);
                    shuffledCards.forEach((cardData, index) => {
                        const cardElement = document.createElement('div');
                        cardElement.className = 'tarot-card';
                        cardElement.dataset.id = cardData.id;
                        cardElement.innerHTML = '<div class="card-face card-back"></div>';
                        Object.assign(cardElement.style, { left: `${deckRect.left - areaRect.left}px`, top: `${deckRect.top - areaRect.top}px` });
                        UI.containers.cardArea.appendChild(cardElement);
                        const position = positions[index];
                        gsap.to(cardElement, { left: position.x, top: position.y, rotation: position.rotation, duration: CONSTANTS.ANIMATION_DURATION / 1000, delay: index * 0.02, ease: 'power2.out' });
                    });
                    gsap.to(deck, { opacity: 0, duration: 0.5, onComplete: () => deck.remove() });
                    setTimeout(() => { document.querySelectorAll('.tarot-card').forEach(card => { card.addEventListener('mousedown', DragDrop.startDrag); card.addEventListener('touchstart', DragDrop.startDrag, { passive: false }); }); Effects.updateBreathingCards(); Effects.updateMagneticSlots(); }, shuffledCards.length * 20 + CONSTANTS.ANIMATION_DURATION);
                },
                showPlacementToast(slotName, cardName) { const toast = document.createElement('div'); toast.className = 'placement-toast'; toast.innerHTML = `<h4>${slotName}</h4><p>${cardName}</p>`; document.body.appendChild(toast); setTimeout(() => toast.remove(), CONSTANTS.TOAST_DURATION); }
            };

            const DragDrop = {
                startDrag(e) { e.preventDefault(); const card = e.target.closest('.tarot-card'); if (card.classList.contains('is-dropped')) return; appState.draggedCard = card; Audio.init(); Audio.play('cardClick'); Vibration.trigger(50); const rect = card.getBoundingClientRect(); const clientX = e.clientX || e.touches[0].clientX; const clientY = e.clientY || e.touches[0].clientY; appState.dragOffset = { x: clientX - rect.left, y: clientY - rect.top }; card.classList.add('is-dragging'); gsap.to(card, { scale: 1.1, duration: 0.2 }); Effects.createRipple(clientX - rect.left, clientY - rect.top, card); document.addEventListener('mousemove', DragDrop.handleDrag); document.addEventListener('mouseup', DragDrop.endDrag); document.addEventListener('touchmove', DragDrop.handleDrag, { passive: false }); document.addEventListener('touchend', DragDrop.endDrag); },
                handleDrag(e) { if (!appState.draggedCard) return; e.preventDefault(); const clientX = e.clientX || e.touches[0].clientX; const clientY = e.clientY || e.touches[0].clientY; const parentRect = UI.containers.cardArea.getBoundingClientRect(); const newX = clientX - parentRect.left - appState.dragOffset.x; const newY = clientY - parentRect.top - appState.dragOffset.y; Object.assign(appState.draggedCard.style, { left: `${newX}px`, top: `${newY}px` }); DragDrop.checkSlotProximity(); },
                checkSlotProximity() { const cardRect = appState.draggedCard.getBoundingClientRect(); const cardCenterX = cardRect.left + cardRect.width / 2; const cardCenterY = cardRect.top + cardRect.height / 2; let closestSlot = null, minDistance = Infinity; UI.containers.cardSlots.forEach(slot => { if (slot.classList.contains('filled')) return; const slotRect = slot.getBoundingClientRect(); const slotCenterX = slotRect.left + slotRect.width / 2; const slotCenterY = slotRect.top + slotRect.height / 2; const distance = Math.hypot(cardCenterX - slotCenterX, cardCenterY - slotCenterY); if (distance < minDistance) { minDistance = distance; closestSlot = slot; } }); UI.containers.cardSlots.forEach(slot => { const shouldActivate = (slot === closestSlot && minDistance < slot.clientWidth); slot.classList.toggle('drag-over', shouldActivate); slot.classList.toggle('attracting', shouldActivate && effects.magnetic.enabled); }); },
                endDrag() { if (!appState.draggedCard) return; document.removeEventListener('mousemove', DragDrop.handleDrag); document.removeEventListener('mouseup', DragDrop.endDrag); document.removeEventListener('touchmove', DragDrop.handleDrag); document.removeEventListener('touchend', DragDrop.endDrag); appState.draggedCard.classList.remove('is-dragging'); const droppedSlot = document.querySelector('.card-slot.drag-over'); if (droppedSlot) { DragDrop.handleDrop(appState.draggedCard, droppedSlot); } else { gsap.to(appState.draggedCard, { scale: 1, duration: 0.3, ease: 'back.out' }); } UI.containers.cardSlots.forEach(slot => slot.classList.remove('drag-over', 'attracting')); appState.draggedCard = null; },
                handleDrop(cardElement, slot) { const cardData = tarotCardsData.find(c => c.id == cardElement.dataset.id); const slotId = parseInt(slot.dataset.slotId); const labels = ["Ваш Вызов", "Ваш Путь", "Ваш Исход"]; appState.chosenCards[slotId] = cardData; Audio.play('cardDrop'); Vibration.trigger(100); cardElement.style.pointerEvents = 'none'; cardElement.classList.add('is-dropped'); slot.classList.add('filled'); const slotRect = slot.getBoundingClientRect(); const areaRect = UI.containers.cardArea.getBoundingClientRect(); gsap.to(cardElement, { left: slotRect.left - areaRect.left, top: slotRect.top - areaRect.top, scale: 1, rotation: 0, duration: 0.4, ease: 'power2.inOut', onComplete: () => { cardElement.removeAttribute('style'); slot.innerHTML = ''; slot.appendChild(cardElement); cardElement.innerHTML = `<div class="card-face card-back"></div><div class="card-face card-front" style="background-image: url('${cardData.image}')"></div>`; gsap.to(cardElement, { rotationY: 180, duration: 0.7, ease: 'power2.inOut' }); GameLogic.showPlacementToast(labels[slotId], cardData.name); Audio.play('cardFlip'); if (appState.chosenCards.filter(c => c).length === 3) { Audio.play('complete'); Vibration.trigger([100, 50, 100]); if (effects.confetti.enabled) Confetti.create(); setTimeout(() => ResultScreen.initialize(appState.chosenCards), CONSTANTS.TOAST_DURATION); } } }); }
            };

            const DevPanel = {
                setup() {
                    UI.devPanel.toggle.addEventListener('click', () => UI.devPanel.content.classList.toggle('active'));
                    UI.devPanel.elements.themeSelect.addEventListener('change', (e) => { document.body.className = e.target.value; Particles.init(); });
                    Object.entries(UI.devPanel.elements).forEach(([key, element]) => { if (element && element.type === 'checkbox') { element.addEventListener('change', (e) => { const effectName = key.replace('Toggle', ''); if (effects[effectName]) { effects[effectName].enabled = e.target.checked; this.updateEffect(effectName); Settings.save(); } }); } });
                    UI.devPanel.elements.restartBtn.addEventListener('click', () => { Settings.save(); location.reload(); });
                },
                updateEffect(effectName) {
                    switch (effectName) {
                        case 'breathing': Effects.updateBreathingCards(); break;
                        case 'magnetic': Effects.updateMagneticSlots(); break;
                        case 'deckBreathing': Effects.updateDeckBreathing(); break;
                    }
                }
            };
            
            function init() {
                try { Settings.load(); Settings.applyToUI(); Particles.init(); Confetti.init(); DevPanel.setup(); UI.buttons.start.addEventListener('click', () => { Navigation.switchScreen('focus'); UI.containers.app.classList.add('focus-active'); }); UI.screens.focus.addEventListener('click', () => { UI.containers.app.classList.remove('focus-active'); GameLogic.setupChoiceScreen(); }); Navigation.switchScreen('start'); } catch (error) { console.error('Ошибка инициализации приложения:', error); }
            }
            init();

            // ===================================
            // === ЛОГИКА ОКНА РЕЗУЛЬТАТОВ (ИНТЕГРАЦИЯ) ===
            // ===================================
            const ResultScreen = {
                currentCard: 0,
                cardData: [],
                touchStartX: 0,

                initialize(chosenCards) {
                    this.currentCard = 0;
                    const aspects = ["Вызов", "Путь", "Исход"];
                    const themes = ["challenge", "path", "outcome"];
                    this.cardData = chosenCards.map((card, index) => ({ ...card, aspect: aspects[index], theme: themes[index] }));
                    this.render();
                    this.update();
                    this.setupEventListeners();
                    document.getElementById('result-modal').classList.add('active');
                },

                render() {
                    const container = document.getElementById('screens-container');
                    container.innerHTML = ''; 

                    this.cardData.forEach((card, index) => {
                        const keywordsHTML = card.keywords.split(',').map(k => `<span class="keyword">${k.trim()}</span>`).join('');
                        const screen = document.createElement('div');
                        screen.className = 'result-screen';
                        screen.dataset.index = index;
                        screen.innerHTML = `
                            <div class="result-image-section">
                                <div class="result-image-wrapper" onclick="ResultScreen.openFullscreen('${card.image}')">
                                    <img src="${card.image}" alt="${card.name}" class="result-image">
                                </div>
                            </div>
                            <div class="result-content-section">
                                <div class="result-title-section">
                                    <div class="result-aspect-label">${card.aspect}</div>
                                    <div class="result-card-name">${card.name}</div>
                                </div>
                                <div class="guidance-text">${this.getGuidanceText(card.aspect)}</div>
                                <div class="content-block"><div class="content-text">${card.general}</div></div>
                                <div class="content-block" onclick="this.classList.toggle('open')">
                                    <div class="content-block-header"><span>💻</span> Для проекта</div>
                                    <div class="content-block-details"><div class="content-text">${card.project}</div></div>
                                </div>
                                <div class="content-block" onclick="this.classList.toggle('open')">
                                    <div class="content-block-header"><span>🚀</span> Для карьеры</div>
                                    <div class="content-block-details"><div class="content-text">${card.career}</div></div>
                                </div>
                                <div class="content-block"><div class="keywords">${keywordsHTML}</div></div>
                            </div>`;
                        container.appendChild(screen);
                    });

                    const aiScreen = document.createElement('div');
                    aiScreen.className = 'result-screen';
                    aiScreen.dataset.index = 3;
                    aiScreen.innerHTML = `
                        <div class="result-image-section">
                            <div class="result-image-wrapper">
                                <img src="images/oracul.png" alt="AI Oracle" class="result-image">
                            </div>
                        </div>
                        <div class="result-content-section" style="justify-content: center;">
                             <div id="ai-screen-content">
                                 <div class="result-aspect-label">Оракул</div>
                                 <h2 class="ai-title">Глубинный Анализ</h2>
                                 <p class="ai-subtitle">Нейросеть может заглянуть глубже. Получите персональную трактовку вашего IT-расклада.</p>
                                 <button class="ai-action-btn" onclick="ResultScreen.showAI()">Раскрыть предсказание</button>
                            </div>
                        </div>`;
                    container.appendChild(aiScreen);
                },

                update() {
                    const screens = document.querySelectorAll('.result-screen');
                    const modalContent = document.getElementById('modal-content');
                    const prevBtn = document.getElementById('prev-btn');
                    const nextBtn = document.getElementById('next-btn');
                    if (!screens.length) return;
                    
                    const currentTheme = (this.currentCard < 3) ? this.cardData[this.currentCard].theme : 'ai';
                    modalContent.className = `modal-content ${currentTheme}-theme`;

                    screens.forEach((screen, index) => {
                        screen.classList.remove('active', 'prev');
                        if (index == this.currentCard) screen.classList.add('active');
                        else if (index < this.currentCard) screen.classList.add('prev');
                    });
                    
                    prevBtn.disabled = this.currentCard === 0;
                    nextBtn.disabled = this.currentCard === screens.length - 1;
                },
                
                setupEventListeners() {
                    document.getElementById('close-modal-btn').onclick = () => {
                        document.getElementById('result-modal').classList.remove('active');
                        GameLogic.setupChoiceScreen(); 
                    };
                    document.getElementById('prev-btn').onclick = () => this.prevCard();
                    document.getElementById('next-btn').onclick = () => this.nextCard();
                    
                    const container = document.getElementById('result-modal');
                    container.addEventListener('touchstart', (e) => { this.touchStartX = e.touches[0].clientX; });
                    container.addEventListener('touchend', (e) => {
                        const touchEndX = e.changedTouches[0].clientX;
                        const diff = this.touchStartX - touchEndX;
                        if (Math.abs(diff) > 50) { if (diff > 0) this.nextCard(); else this.prevCard(); }
                    });
                    
                    document.addEventListener('keydown', (e) => {
                        if (document.getElementById('ai-overlay').classList.contains('active')) {
                            if (e.key === 'Escape') this.hideAI();
                            return;
                        }
                        if (!document.getElementById('result-modal').classList.contains('active')) return;
                        
                        if (e.key === 'ArrowLeft') this.prevCard();
                        if (e.key === 'ArrowRight') this.nextCard();
                        if (e.key === 'Escape') {
                            if (document.getElementById('fullscreen-overlay').classList.contains('active')) this.closeFullscreen();
                            else document.getElementById('close-modal-btn').click();
                        }
                    });
                },
                
                nextCard() { if (this.currentCard < 3) { this.currentCard++; this.update(); } },
                prevCard() { if (this.currentCard > 0) { this.currentCard--; this.update(); } },

                getGuidanceText(aspect) {
                    const texts = { 'Вызов': 'Ваше главное испытание. Не враг, а учитель, указывающий путь к росту.', 'Путь': 'Ваша стратегия. Методы и ресурсы для преодоления вызовов.', 'Исход': 'Вероятный результат. Сценарий, который вы можете формировать.' };
                    return texts[aspect] || '';
                },

                openFullscreen(src) { document.getElementById('fullscreen-image').src = src; document.getElementById('fullscreen-overlay').classList.add('active'); },
                closeFullscreen() { document.getElementById('fullscreen-overlay').classList.remove('active'); },
                showAI() { document.getElementById('ai-overlay').classList.add('active'); },
                hideAI() { document.getElementById('ai-overlay').classList.remove('active'); },
                requestAI() {
                    const question = document.getElementById('ai-question').value;
                    const responseEl = document.getElementById('ai-response');
                    const btnText = document.getElementById('ai-btn-text');
                    if (!question.trim()){ alert("Введите ваш вопрос."); return; }
                    btnText.textContent = 'Анализ...';
                    responseEl.classList.add('visible');
                    responseEl.innerHTML = `<em style="color: var(--ai-light);">🔮 Соединяюсь с цифровым потоком...</em>`;
                    
                    setTimeout(() => {
                        let summary = `<div style="border-left: 4px solid var(--ai-secondary); padding-left: 1rem;">
                            <strong style="color: var(--ai-light);">🤖 Комплексный анализ расклада:</strong><br><br>
                            <strong style="color: white;">Ваш вопрос:</strong> "${question}"<br><br>
                            Ваш путь начинается с <strong>Вызова (${this.cardData[0].name})</strong>, что говорит о необходимости ${this.cardData[0].general.toLowerCase()}. 
                            Для его преодоления, ваш <strong>Путь (${this.cardData[1].name})</strong> лежит через ${this.cardData[1].general.toLowerCase()}.
                            Если вы последуете этому пути, вероятный <strong>Исход (${this.cardData[2].name})</strong> — это ${this.cardData[2].general.toLowerCase()}.
                            <br><br>
                            <em style="color: #ccc;">Этот анализ основан на синергии карт и вашем вопросе.</em>
                            </div>`;
                        responseEl.innerHTML = summary;
                        btnText.textContent = 'Спросить';
                    }, 2500);
                }
            };

        });
    </script>
</body>
</html>